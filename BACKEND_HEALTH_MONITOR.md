# 🏥 后端健康监控系统

## 📋 问题描述

**用户痛点：**
- 用户使用虚拟试穿功能时，后端服务可能未启动
- 前端报错信息不友好，用户不知道如何解决
- 开发者不在现场时，无法及时发现和修复问题
- 生产环境需要保证服务高可用

---

## ✅ 解决方案

### 1. 前端自动健康监控 ⭐⭐⭐⭐⭐

**功能特性：**
- ✅ 每 30 秒自动检查后端状态
- ✅ 后端离线时每 5 秒快速重连
- ✅ 实时显示连接状态（在线/离线/检查中）
- ✅ 友好的错误提示和解决方案
- ✅ 一键重试功能

**实现文件：**
- `src/services/backend-health-monitor.ts` - 健康监控服务
- `src/components/BackendStatusIndicator.tsx` - 状态指示器组件
- `src/components/layout/Layout.tsx` - 集成到主布局

**用户体验：**
```
后端在线 → 不显示任何提示（不打扰用户）
后端离线 → 右下角显示红色提示卡片
         → 自动尝试重连
         → 提供解决方案
         → 一键重试按钮
```

---

### 2. 增强的错误处理 ⭐⭐⭐⭐

**功能特性：**
- ✅ 统一的错误处理函数
- ✅ 友好的错误消息
- ✅ 明确的解决建议
- ✅ 请求超时控制（10秒）

**实现文件：**
- `src/services/api/backend-api.ts` - 后端 API 调用服务

**错误提示示例：**
```
❌ 无法连接到后端服务器
   请确认后端服务已启动（端口3100）
   
   运行命令：
   cd backend && npm run dev:fixed
```

---

### 3. PM2 进程守护（生产环境）⭐⭐⭐⭐⭐

**功能特性：**
- ✅ 自动重启（崩溃后立即重启）
- ✅ 内存监控（超限自动重启）
- ✅ 日志管理（自动记录和轮转）
- ✅ 开机自启（系统重启后自动启动）
- ✅ 性能监控（CPU、内存实时监控）

**实现文件：**
- `ecosystem.config.js` - PM2 配置文件
- `start-production.bat` - 一键启动脚本（Windows）
- `PRODUCTION_DEPLOYMENT.md` - 完整部署文档

**使用方法：**
```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status

# 查看日志
pm2 logs
```

---

## 🎯 用户场景

### 场景1：开发环境

**用户操作：**
1. 打开前端页面
2. 点击"虚拟试穿"
3. 上传照片和衣服

**系统行为：**
- ✅ 前端自动检测后端状态
- ✅ 如果后端未启动，右下角显示红色提示
- ✅ 提示用户启动后端：`cd backend && npm run dev:fixed`
- ✅ 用户启动后端后，系统自动检测到并隐藏提示
- ✅ 用户可以正常使用功能

---

### 场景2：生产环境

**部署步骤：**
1. 配置 `backend/.env` 文件
2. 运行 `start-production.bat`（Windows）或 `pm2 start ecosystem.config.js`（Linux）
3. 访问前端页面

**系统保障：**
- ✅ 后端服务自动启动
- ✅ 崩溃后自动重启（最多10次）
- ✅ 内存超限自动重启（500MB）
- ✅ 系统重启后自动启动
- ✅ 前端实时监控后端状态
- ✅ 用户始终能看到清晰的状态提示

---

### 场景3：后端临时离线

**发生情况：**
- 后端服务崩溃
- 网络临时中断
- 服务器重启

**系统行为：**
1. **前端检测到离线**（30秒内）
2. **显示红色提示卡片**
   - "后端服务离线"
   - "正在尝试重连..."
3. **自动快速重连**（每5秒）
4. **PM2 自动重启后端**（生产环境）
5. **前端检测到恢复**
6. **隐藏提示，恢复正常**

**用户体验：**
- 用户清楚知道发生了什么
- 不需要刷新页面
- 系统自动恢复
- 无需人工干预

---

## 📊 监控界面

### 前端状态指示器

**位置：** 页面右下角

**状态1：在线（绿色）**
```
┌─────────────────────────┐
│ 🟢 后端服务在线         │
│    连接正常             │
└─────────────────────────┘
```
*不显示（不打扰用户）*

**状态2：离线（红色）**
```
┌─────────────────────────────────┐
│ 🔴 后端服务离线                 │
│    正在尝试重连...              │
│                                 │
│ 无法连接到后端服务              │
│                                 │
│ 可能的原因：                    │
│ • 后端服务器未启动              │
│ • 端口 3100 被占用              │
│ • 网络连接问题                  │
│                                 │
│ 解决方法：                      │
│ • 运行: cd backend &&           │
│   npm run dev:fixed             │
│ • 检查终端是否有错误信息        │
│ • 刷新页面重试                  │
│                                 │
│ [     立即重试     ]            │
└─────────────────────────────────┘
```

**状态3：检查中（黄色）**
```
┌─────────────────────────┐
│ 🟡 检查连接中           │
│    请稍候...            │
└─────────────────────────┘
```

---

## 🔧 技术实现

### 架构图

```
┌─────────────────────────────────────────┐
│           前端应用（React）              │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  BackendHealthMonitor Service   │   │
│  │  • 每30秒心跳检测               │   │
│  │  • 离线时每5秒快速重连          │   │
│  │  • 状态变化通知                 │   │
│  └──────────────┬──────────────────┘   │
│                 │                       │
│  ┌──────────────▼──────────────────┐   │
│  │  BackendStatusIndicator         │   │
│  │  • 实时显示连接状态             │   │
│  │  • 友好的错误提示               │   │
│  │  • 一键重试功能                 │   │
│  └─────────────────────────────────┘   │
└─────────────────┬───────────────────────┘
                  │ HTTP
                  │ GET /health
                  │
┌─────────────────▼───────────────────────┐
│         后端服务（Node.js）              │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Express Server                 │   │
│  │  • GET /health                  │   │
│  │  • GET /api/config              │   │
│  │  • POST /api/bailian-tryon      │   │
│  └─────────────────────────────────┘   │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│            PM2 进程管理器                │
│  • 自动重启                             │
│  • 内存监控                             │
│  • 日志管理                             │
│  • 性能监控                             │
└─────────────────────────────────────────┘
```

---

## 📈 监控数据

### 健康检查频率

| 状态 | 检查间隔 | 说明 |
|------|---------|------|
| 正常运行 | 30秒 | 定期心跳检测 |
| 检测到离线 | 5秒 | 快速重连尝试 |
| 用户手动重试 | 立即 | 响应用户操作 |

### 超时设置

| 操作 | 超时时间 | 说明 |
|------|---------|------|
| 健康检查 | 5秒 | 避免长时间等待 |
| API 调用 | 10秒 | 给予足够处理时间 |
| 虚拟试穿 | 60秒 | AI 处理需要时间 |

---

## 🎨 用户界面

### 颜色方案

- 🟢 **绿色**：服务在线，一切正常
- 🔴 **红色**：服务离线，需要注意
- 🟡 **黄色**：检查中，请等待

### 动画效果

- ✅ 淡入淡出动画（`animate-fade-in`）
- ✅ 脉冲动画（离线图标）
- ✅ 旋转动画（检查中图标）

---

## 🚀 部署清单

### 开发环境

- [x] 前端健康监控服务
- [x] 状态指示器组件
- [x] 增强的错误处理
- [x] 友好的错误提示

### 生产环境

- [x] PM2 配置文件
- [x] 一键启动脚本
- [x] 日志目录
- [x] 部署文档
- [x] 自动重启机制
- [x] 内存监控
- [x] 开机自启

---

## 📝 使用说明

### 开发者

**启动开发环境：**
```bash
# 后端
cd backend
npm run dev:fixed

# 前端
npm run dev:fixed
```

**查看监控状态：**
- 打开浏览器开发者工具（F12）
- 查看 Console 日志
- 观察右下角状态指示器

### 运维人员

**部署生产环境：**
```bash
# 1. 安装 PM2
npm install -g pm2

# 2. 配置环境变量
# 编辑 backend/.env

# 3. 启动服务
pm2 start ecosystem.config.js

# 4. 设置开机自启
pm2 startup
pm2 save
```

**监控服务：**
```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs smart-wardrobe-backend

# 实时监控
pm2 monit
```

---

## 🎉 成果总结

### 解决的问题

✅ **用户体验问题**
- 用户清楚知道后端状态
- 提供明确的解决方案
- 自动重连，无需刷新页面

✅ **开发体验问题**
- 友好的错误提示
- 快速定位问题
- 便捷的调试工具

✅ **运维问题**
- 自动重启机制
- 完善的日志记录
- 实时性能监控
- 开机自启动

### 技术亮点

⭐ **前端心跳检测**：实时监控后端状态
⭐ **自动重连机制**：离线后自动恢复
⭐ **友好的UI提示**：用户体验优先
⭐ **PM2进程守护**：生产环境高可用
⭐ **完善的文档**：易于部署和维护

---

## 📞 技术支持

如有问题，请查看：
- `PRODUCTION_DEPLOYMENT.md` - 完整部署文档
- `logs/backend-error.log` - 错误日志
- `logs/backend-out.log` - 输出日志

---

**🎊 现在您的智能衣柜拥有了企业级的健康监控系统！**

